<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>貼り付けボード</title>
  <script type="text/javascript" src="js/react.js"></script>
  <script type="text/javascript" src="js/react-dom.js"></script>
  <script type="text/javascript" src="js/browser.min.js"></script>
  <style>
    body {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
    }

    .center {
      display: block;
      color: #2c3e50;
      width: 30%;
      font-family: Source Sans Pro, Helvetica, sans-serif;

    }

    .top {
      margin-top: 10%;

    }

    .first {
      display: flex;
      margin-bottom: 3px;
    }

    .label {
      text-align: left;
      width: 20%;
    }

    .div-id {
      width: 80%;
    }

    #ID {
      width: 100%;
    }

    .input {
      margin-bottom: 3px;
      width: 100%;

    }

    #CONTENT {
      width: 100%;
      height: 10em;
    }

    .btn {
      width: 100%;
    }

    .banner {
      width: 100%;
      text-align: right;
      display: flex;
    }

    .post {
      display:block;
      width:100%;
      height:auto;
      border-radius: 5px;
      border: 2px solid;
      margin-top:2px;
      margin-bottom:2px;

    }

    .msg-id {
      color: black;
      font-weight: bolder;
      margin-left:5px;
      font-size: 1em;
      text-align: left;
      margin-bottom: 3px;
    }


    .msg-content {
      margin-left:5px;
      text-align: left;
      font-size: 15px;
      margin-bottom: 5px;
    }

    .msg-date {
      margin-left:5px;
      margin-top:5px;
      color: cyan;
      font-weight: lighter;
      font-size: 10px;
      text-align: left;
      margin-bottom:5px;
    }
  </style>

</head>
<body>
<div class="center">
  <div class="top">
    <div class="first">
      <div class="label">发帖人 ID:</div>
      <div class="div-id"><input id="ID" type="text"></div>
    </div>
    <div class="input"><textarea id="CONTENT"></textarea></div>
    <div class="banner">
      <div id="indicator"></div>
      <div class="btn">
        <button>发送</button>
      </div>
    </div>
  </div>
  <div class="bottom">
    Loading...
  </div>
</div>

<script type="text/babel">
  const Component = React.Component;

  class Msg extends Component {
    constructor(props){
      super(props)
    }
    render(){
      return (
          <div className="post">
            <div className="msg-id">{this.props.uid}</div>
            <div className="msg-content">{this.props.content}</div>
            <div className="msg-date">{this.props.date}</div>
          </div>

    );

    }
  }
  class MsgBoard extends Component {
    constructor(props){
      super(props)
    }
    render(){
      var children = [];
      var arr = this.props.data;
      for(var i=0;i<arr.length;i++)
        children.push(<Msg key={arr[i]._id} uid={arr[i].id} content={arr[i].content} date={(new Date(arr[i].timetag))
            .toLocaleString()}/>);
      children.reverse();
      return (
          <div>
            {children}
          </div>
      );

    }
  }
  class Indicator extends Component{
    constructor(props){
      super(props);
    }
    render(){
      var color ="";
      if(this.props.len0>=140)
        color="red";
      else
        color="black";
      return (<div style={{color:color}}>{140 - this.props.len0}</div>)
    }
  }


  Indicator.defaultProps = {
    len0:0
  };

  //localStorage.clear();
//  dataStorage = JSON.parse(localStorage.getItem('latest5'));

  var id = document.getElementById('ID');
  var input = document.getElementById('CONTENT');
  var indicator = document.getElementById('indicator');
  var btn = document.getElementsByTagName('button')[0];
  var bottom = document.getElementsByClassName('bottom')[0];

  var time = 0;
  function post() {
    var _id = id.value;
    var content = input.value;
    if (content.length>140){
      alert('字数超限 无法发送')
      return;
    }
    var form = {content};
    if(!_id||!content){
      alert('请输入 ID 或内容');
      return;
    }

    fetch('/api/post/' + _id, {
      method: "POST",
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(form)
    }).then((res)=> {
      return res.json();
    });
  }
  function fetchAll() {
    fetch('/api/all')
        .then(r => {
          return r.json()
        })
        .then(t => {
          console.log(t)
        })
  }
  var dataStorage=new Array(0);
  try {
    var l = dataStorage.length;
    if (dataStorage[l-1])
      time = dataStorage[l-1].timetag;

    if(!time)
      time = 0;
  }
  catch (e){
    console.log(e);

  }


  function fetchLatest(t) {
    fetch('/api/latest/' + t)
        .then(r => {
          return r.json()
        })
        .then(t => {
              if (t.status) {


                if (dataStorage.length===0)
                  dataStorage = t.obj;
                else
                  if(t.obj){

                    dataStorage.push.apply(dataStorage,t.obj);
                  }


//                if (dataStorage.length <= 5)
//                  localStorage.setItem('latest5', JSON.stringify(dataStorage));
//                else
//                  localStorage.setItem('latest5', JSON.stringify(dataStorage.slice(-5)));
                var l = dataStorage.length;
                var d = dataStorage[l-1];

                time = d.timetag||t.obj[t.obj.length -1].timetag;
                //console.log(dataStorage.length+' '+d);

               // if(d)
               //   ReactDOM.render(<Msg uid={d.id} content={d.content} date={(new Date(d.timetag)).toLocaleString()}/>,bottom);
                if(dataStorage)
                  ReactDOM.render(<MsgBoard data={dataStorage}/>,bottom);
              }
              else {
                if (t.obj === "Empty") {
                  //do sth;

                }
              }
            }
        ).catch(e=>console.log(e)/*alert('Failed to fetch latest items.')*/);
  }

  btn.addEventListener('click', post);

  ReactDOM.render(<Indicator />, indicator);

  input.addEventListener('keyup', function () {
    var len=String(input.value).length||0;

    ReactDOM.render(<Indicator len0={len}/>, indicator)
  });
  setInterval(()=> {
    fetchLatest(time)
  }, 1000);

</script>

</body>

</html>